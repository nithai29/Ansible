--- 
  - hosts: localhost
    gather_facts: false
    tasks:
      - name: Importing required variables
        include_vars: vars/bastion_vars

      - name: Importing additional required variables
        include_vars: vars/output_vars

      - name: create a new key pair, return generated private key
        ec2_key:
          name: "{{keypair_name}}"
          region: "us-east-1"
        register: keypair_output
      
      # - name: displaying the keypair output
      #   debug:
      #     var: keypair_output
      
      - name: Download the keypair
        copy:
          content: "{{ keypair_output.key.private_key }}"
          dest: "{{keypair_name}}.pem"
          mode: 0400
        when: keypair_output.changed

      - name: security group for bastion hosts
        ec2_group:
          name: Bastion-SG
          description: Bastion host security group
          region: "{{region}}"
          vpc_id: "{{vpcid}}"
          rules:
            - proto: tcp
              from_port: 22
              to_port: 22
              cidr_ip: "{{myIP}}"
              rule_desc: allow ssh traffic from my IP
          tags:
            Name: "Bastion host SG"
        register: bastion_sg_information

      - debug: 
          var: bastion_sg_information

      # - name: creating bastion host
      #   ec2:
      #     key_name: "{{keypair_name}}"
      #     instance_type: t2.micro
      #     image: "{{ami}}"
      #     wait: yes
      #     group: Bastion-SG
      #     count: 1
      #     vpc_subnet_id: "{{pubsub01id}}"
      #     assign_public_ip: yes
