--- 
  - hosts: localhost
    gather_facts: false
    tasks:
      - name: Importing required variables
        include_vars: vars/bastion_vars

      - name: Importing additional required variables
        include_vars: vars/output_vars

      - name: create a new key pair, return generated private key
        ec2_key:
          name: "{{keypair_name}}"
          region: "{{region}}"
        register: keypair_output
      
      - name: Download the keypair
        copy:
          content: "{{keypair_output.key.private_key}}"
          dest: "{{keypair_name}}.pem"
          mode: 0400
        when: keypair_output.changed

      - name: security group for bastion hosts
        ec2_group:
          name: "{{sg_name}}"
          description: "{{desc}}"
          region: "{{region}}"
          vpc_id: "{{vpcid}}"
          rules:
            - proto: tcp
              from_port: 22
              to_port: 22
              cidr_ip: "{{myIP}}"
              rule_desc: allow ssh traffic from my IP
          tags:
            Name: "Bastion host SG"
        register: bastion_sg_information

      - name: creating bastion host
        ec2:
          key_name: "{{keypair_name}}"
          instance_type: t2.micro
          image: "{{ami}}"
          wait: yes
          group_id: "{{bastion_sg_information.group_id}}"
          # count: 1
          region: "{{region}}"
          vpc_subnet_id: "{{pubsub01id}}"
          assign_public_ip: yes
          instance_tags:
            Name: Bastion Host
            Service: Jump Server
            Environment: "{{env}}"
            Resource owner: "{{res_owner}}"
            Team: "{{team}}"
          exact_count: 1
          count_tag:
            Name: Bastion Host
            Service: Jump Server
            Environment: "{{env}}"
            Resource owner: "{{res_owner}}"
            Team: "{{team}}"
        register: Bastion_host_information

        - name: create an ec2 output file 
          copy:
            content: "bastion_keypair: {{keypair_output.key.name}}\nbastion_ec2_sg: {{bastion_sg_information.group_id}}\nbastion_ec2_host: {{Bastion_host_information}}"
            dest: vars/bastion_output_vars
      